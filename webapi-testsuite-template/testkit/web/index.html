<!--
 Copyright (C) 2012, Intel Corporation.

 This program is free software; you can redistribute it and/or modify it
 under the terms and conditions of the GNU General Public License,
 version 2, as published by the Free Software Foundation.

 This program is distributed in the hope it will be useful, but WITHOUT
 ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 for more details.

 You should have received a copy of the GNU General Public License along with
 this program; if not, write to the Free Software Foundation, Inc., 59 Temple
 Place - Suite 330, Boston, MA 02111-1307 USA.

 Authors:
	Jing Wang <jing.j.wang@intel.com>
-->
<!doctype html>
<head>
<script src="jquery.js"></script>
<script>
var iTest = 0;

var Tests;
var statusNode;
var oTestFrame;
var statusFrame;
var frmset;
var xmldoc;

var startTime;
var runTime = 0;
var defTime = 2000;
var pollTime = defTime;
var timeout;
var winCloseTimeout = 5000;

var server = "http://127.0.0.1:8000";

var hidestatus;
var ttestsuite;
var tpriority;
var tstatus;
var ttype;
var tcategory;
var texecutiontype;

var manualcaseslist;

var cursuite;
var curset;

var last_test_page = "";
var current_page_uri = "";

var manualcases = function(){
	this.casesid = "";
	this.index = 0;
	this.result = "";
}

function getTestPageParam(uri, param)
{
	var uri = uri;
	var iLen = param.length;
	var iStart = uri.indexOf(param);
	if (iStart == -1)
		return "";
	iStart += iLen + 1;
	var iEnd = uri.indexOf("&", iStart);
	if (iEnd == -1)
		return uri.substring(iStart);

	return uri.substring(iStart, iEnd);
}

function Parm(data, name)
{
    var p;
    ts = $(data).find(name);
    if (ts){
        t = $(ts).get(0);
        if (t)
            p = $(t).text().trim();
    }

    if (p) {
        var rawVal = decodeURI(p);
        if (rawVal.indexOf(',')<0)
            p = rawVal;
        else
            p = rawVal.split(',');
    }

    return p;
}

function getParms()
{
    var parms = new Array();
    var str = location.search.substring(1);
    var items =  str.split('&');
    for (var i=0; i<items.length; i++){
        var pos = items[i].indexOf('=')
        if (pos > 0){
            var key = items[i].substring(0, pos)
            var val = items[i].substring(pos + 1)
            if (! parms[key]){
                var rawVal = decodeURI(val);
                if (rawVal.indexOf(',')<0)
                    parms[key] = rawVal;
                else
                    parms[key] = rawVal.split(',');
            }
        } 
    }

    ttestsuite = parms["testsuite"];
    tpriority = parms["priority"];
    hidestatus = parms["hidestatus"];
    tstatus = parms["status"];
    ttype = parms["type"];
    tcategory = parms["category"];
    texcutiontype = parms["execution_type"];

    $.ajax({
        async: false,
        type: "GET",
        url: server + "/get_params",
        dataType: "xml",
        success: function(data){
            hidestatus = Parm(data, 'hidestatus');
	}
        
     });
}

function runTestsuite_nofilter(xml) {
            xmldoc = xml;
            Tests = $(xml).find("testcase");
            doTest();
}


function runTestsuite(xml) {
            xmldoc = xml;
            $(xml).find("testcase").each(function() {
                var v, vType;
                v = $(this).attr('execution_type');
                
                if (texecutiontype && texecutiontype == "manual")
                    vType = "manual";
                else if (texecutiontype && texecutiontype == "auto")
                    vType = "auto";
                else if (!texecutiontype)
                    vType = "auto";
                else      
                    vType = ["auto","manual"];

		if (v!=vType && $.inArray(v, vType)<0)
                    $(this).remove();
                v = $(this).attr('priority');
                if (tpriority && v!=tpriority && $.inArray(v, tpriority)<0)
                    $(this).remove();
                v = $(this).attr('status');
                if (tstatus && v!=tstatus && $.inArray(v, tstatus)<0)
                    $(this).remove();
                v = $(this).attr('type');
                if (ttype && v!=ttype && $.inArray(v, ttype)<0)
                    $(this).remove();
                var categories = $(this).find("categories > category");
                if (categories.length>0 && tcategory) {
                    var i;
                    var found = false;
                    for (i=0;i<categories.length;i++) {
                        var category = $(categories).get(i);
			if ($(category).text().trim() != tcategory && $.inArray($(category).text().trim(),tcategory)<0){
                            found = true;
                            break;
                        }
                    }
                    if (! found)
                        $(this).remove();
                }

                $(this).attr('result', "N/A");
            });

            Tests = $(xml).find("testcase");
            xmldoc = xml;
            save_result()
            doTest();
}

function init()
{
    getParms();

    oTestFrame = document.getElementById('testframe');
    if (!oTestFrame)
        return;
 
    statusFrame = document.getElementById('statusframe');
    if (!statusFrame)
        return;

    var statusWin = statusFrame.contentWindow;
    if (!statusWin)
        return;

    statusNode = statusWin.document.createElement("div");
    if (!statusNode) 
        return;
    statusWin.document.body.appendChild(statusNode); 

    frmset = $($('#main')).get(0);
    if (!frmset)
        return;

    if (hidestatus && hidestatus=="1")
        $(frmset).attr('rows', "0, *");

    $.ajax({
        async: false,
        type: "GET",
        url: server + '/get_testsuite',
        dataType: "xml",
        success: runTestsuite_nofilter
    });

    if (!xmldoc) {
        if (!ttestsuite)
            ttestsuite = 'tests.xml';
        $.ajax({
            async: false,
            type: "GET",
            url: ttestsuite,
            dataType: "xml",
            success: runTestsuite
        });
    }
}

function escape_html(s)
{
    return s.replace(/\&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
}

function check_timeout()
{
    if (runTime < timeout) 
        setTimeout("CheckResult()", pollTime);
    else
        report('FAIL', "Test time out");
}

function CheckResult()
{
    var message="";
    var total_num = "";
    var locator_key = "";
    var value = "";

    var oTestWin = oTestFrame.contentWindow;
    var oTestDoc = oTestWin.document;
    //var case_uri = oTestFrame.src.toString();
    var case_uri = current_page_uri; 

    runTime += pollTime; 

    try
    {
        if (oTestWin.document.readyState == "complete")
        {
            total_num = getTestPageParam(case_uri, "total_num");
            locator_key = getTestPageParam(case_uri, "locator_key");
            value = getTestPageParam(case_uri, "value");

            oPass = $(oTestDoc).find(".pass");
            oFail = $(oTestDoc).find(".fail");

            // Test page has parameters
            if (total_num != "" && locator_key != "" && value != "") {
                if (locator_key == "id") {
                    var results;
                    var passes;
                    var fails;

                    var oRes = $(oTestDoc).find("table#results");
                    if (oRes) {
                        results = $(oRes).find('tr');
                        passes = $(oRes).find('tr.pass');
                        fails = $(oRes).find('tr.fail');
                    }

                    if (passes.length + fails.length == total_num) {
                            var i = 1;
                            for (i = 1; i <= total_num; i++) {
                                if (i.toString() != value)
                                    continue;

                                var rest = results[i].childNodes[0].innerText;
                                var desc = results[i].childNodes[1].innerText;
                                var msg = results[i].childNodes[2].innerText;
                                //alert(rest + "  :  " + desc + "  :  " + msg);
                                if (rest && rest.toUpperCase() == "PASS")
                                    report('PASS', msg);
                                else
                                    report('FAIL', msg);

                                //break the loop after reports the right result
                                break;
                            }
                    } else {
                        var i;
                        for (i = 0; i < fails.length; i++) {
                            var desccell = fails[i].childNodes[1];
                            if  (desccell)
                                message += "###Test###" + desccell.innerText;
                            var msgcell = fails[i].childNodes[2];
                            if  (msgcell)
                                message += "###Error###" + msgcell.innerText;
                        }

                        report('FAIL', message);
                    }
                } else if (locator_key == "test_name") {
                     //Place holder
                } else if (locator_key == "msg") {
                     //Place holder
                } else {
                    alert("Unknown locator key");
                }
            } else if (oPass.length > 0 && oFail.length == 0) {
                if (oTestWin.resultdiv)
                    message = oTestWin.resultdiv.innerHTML;
                report('PASS', message);
            }else if(oFail.length > 0){
                var oRes = $($(oTestDoc).find("table#results")).get(0);
                // Get error log
                if (oRes) {
                    var fails = $(oRes).find('tr.fail');
                    var i;
                    for (i=0; i<fails.length; i++) {
                        var desccell = fails[i].childNodes[1];
                        if  (desccell)
                            message += "###Test###" + desccell.innerText;
                        var msgcell = fails[i].childNodes[2];
                        if  (msgcell)
                            message += "###Error###" + msgcell.innerText;
                    }
                }
                report('FAIL', message);
            }else if (oTestFrame.src.search(".html") >=0) {
                    var exptxt = oTestFrame.src.replace(/.html$/g, "-expected.txt");
                    $.ajax({
                        type: "GET",
                        url: exptxt,
                        dataType: "text",
                        success: function(txt) {
                            var obody = $(oTestWin.document).find("body");
                            if (obody.length > 0){
                                var otxt = obody[0].innerText;
                                if (otxt.trim()==txt.trim()) 
                                    report('PASS', "");
                                else
                                    report('FAIL', otxt.trim());
                            }else
                                report('FAIL', 'No body tag');
                        },
                        error: function() {
                            check_timeout();
                        }
                    });	
            }else check_timeout(); //oFail.length==0 && oPass.length==0
        }else check_timeout(); // not complete
    }
    catch(e){
        report('FAIL', message);
    }
}


function report(result, log)
{

    if (iTest >= Tests.length) 
        return;
    $(Tests[iTest]).attr('result', result);
    var doc=$.parseXML("<result_info>" + "<actual_result>" + result +"</actual_result>" + "<start>" + startTime + "</start>" + "<end>" + new Date() + "</end>"+"<stdout>"+ escape_html(log) +"</stdout>"+"</result_info>");
    $(Tests[iTest]).append(doc.documentElement);

    statusNode.innerHTML =  "Test #" + (iTest+1) + "/" + Tests.length + "(" + result + ") " + current_page_uri;
 
    try {
        var starts=log.indexOf('value:');
        var stops=log.lastIndexOf(',');
        var resultinfo=log.substring(starts+6, stops);
        $(Tests[iTest]).find("measurement").attr('value', resultinfo);
    } catch(e) {
    }

    iTest++;
    doTest();
}

function doTest()
{
    runTime = 0;
    while(iTest<Tests.length) {
	if ($(Tests[iTest]).attr('execution_type') != 'auto'){
            	iTest++; 
		continue;
	}
        var ts =$(Tests[iTest]).find('test_script_entry');
        if (ts.length==0){
            iTest++; 
            continue;
        }
        var it = $(ts).get(0);
        var tstr= $(it).attr('timeout');
        if (!tstr)
            timeout = 8 * defTime;
        else{
            var t;
            try {
                t = parseInt(tstr) * 1000;
            } catch (e){
                t = 8 * defTime;
            }
            timeout = t;
        }
        
        pset = $(Tests[iTest]).parent().attr('name')
        psuite = $(Tests[iTest]).parent().parent().attr('name')

        startTime = new Date();
        setTimeout("CheckResult()", pollTime);

	current_page_uri = $(it).text();
	var index = current_page_uri.indexOf("?")
	var test_page = "";
	
        var svr = server + "/test_hint";
        try{
            $.ajax({
                async: false,
                type: "POST",
                url: svr,
                data: {suite:psuite, set:pset, testcase:current_page_uri}
            });
        }catch(e){
        }
 
	if (index >= 0)
            test_page = current_page_uri.substring(0, index);
	else
            test_page = current_page_uri;

	// Don't load the same test page again
        if (test_page == last_test_page)
            return;

	if((current_page_uri.indexOf("2DTransforms") != -1) || (current_page_uri.indexOf("3DTransforms") != -1)) {
                parent.document.getElementById("testframe").height = 500000 + "px";
        }  
        oTestFrame.src = current_page_uri;
	last_test_page = test_page;

	return;
    }
    
    doManualTest();
}

function doManualTest(){
	manualcaseslist = new Array();
        var iTemp1 = 0, iTemp2 = 0;
        while(iTemp1 < Tests.length) {
                if ($(Tests[iTemp1]).attr('execution_type') == 'manual'){
			parent.document.getElementById("statusframe").height = 385 + "px";
                        manualcaseslist[iTemp2] = new manualcases();
                        manualcaseslist[iTemp2].casesid = $(Tests[iTemp1]).attr('id');
                        manualcaseslist[iTemp2].index = iTemp1;
                        manualcaseslist[iTemp2].result = $(Tests[iTemp1]).attr('result');
                        iTemp2++;
                }
                iTemp1++;
        }
	if(iTemp2 > 0){
		winCloseTimeout = 50000;
    		statusFrame.src = "./manualharness.html";
    		$(frmset).attr('rows', "100,*");
	} else if (iTest==Tests.length) {
        	setTimeout("PublishResult()", 2000);
    	}
    	oTestFrame.src = '';
}

function PublishResult()
{
    $(frmset).attr('rows', "0, *");
    results = oTestFrame.contentWindow;
    var resultXML;    
    resultXML = "<title>HTML5 Test Result XML</title>";
    resultXML += "<head> <style type='text/css'>\
html {font-family:DejaVu Sans, Bitstream Vera Sans, Arial, Sans;}\
section#summary {margin-bottom:1em;}\
table#results {\
    border-collapse:collapse;\
    table-layout:fixed;\
    width:80%;\
}\
table#results th:first-child,\
table#results td:first-child {\
    width:40%;\
}\
table#results th:last-child,\
table#results td:last-child {\
    width:30%;\
}\
table#results th {\
    padding:0;\
    padding-bottom:0.5em;\
    text-align:left;\
    border-bottom:medium solid black;\
}\
table#results td {\
    padding:1em;\
    padding-bottom:0.5em;\
    border-bottom:thin solid black;\
}\
</style><head>";

    resultXML += "<section id='summary'>";
    resultXML += "<h2>Summary</h2>";
    var ipass = $(xmldoc).find("testcase[result='PASS']").length; 
    var failList = $(xmldoc).find("testcase[result='FAIL']");
    var ifail = failList.length; 
    resultXML += "<h3>Total:" + Tests.length + " Pass:<span style='color:green;'>" + ipass + "</span> Fail:<span style='color:red;'>" + ifail + "</span></h3>" ;
    resultXML += "</section>";
    
    resultXML += "<p><table id='results'> <tr> <th> TestSet </th> <th> Pass </th> <th> Fail </th></tr>";
    var Sets = $(xmldoc).find("set");
    var i=0;
    for (i=0; i< Sets.length; i++) {
	ipass = $(Sets[i]).find("testcase[result='PASS']").length;
        ifail = $(Sets[i]).find("testcase[result='FAIL']").length;
        resultXML += "<tr>";
        resultXML += "<td>" + $(Sets[i]).attr('name') + "</td>"; 
        resultXML += "<td style='color:green;'>" + ipass + "</td><td style='color:red;'>" + ifail + "</td>";
        resultXML += "</tr>";
    } 
    resultXML += "</table>";

    if (ifail > 0)
    {
        resultXML += "<section id='failedlist'>";
        resultXML += "<h2>Fails</h2>";
        resultXML += "<ul>";
        for (i=0; i<failList.length; i++) {
            var ts = $(failList[i]).find("test_script_entry");
            if (ts.length>0)
            {
                var t = ts.get(0);
                resultXML += "<li style='color:red;'>" + $(t).text() + "</li>";
            }
        }
        resultXML += "</ul>";
        resultXML += "</section>"; 
    }

    resultXML += "<h2>Details</h2>";
    resultXML += "<form method='post' id='resultform'> <textarea id='results' style='width: 80%; height: 90%;' name='filecontent' disabled='disabled'>" + save_result() + "</textarea></form>";
    setTimeout("window.open('','_self','');window.close()", winCloseTimeout);
    results.document.writeln(resultXML);
}

function save_result()
{
    var svr = server + "/save_result";
    var testid = (new Date()).getTime();
    var contents=(new XMLSerializer()).serializeToString(xmldoc);
    try{
        $.ajax({
            async: false,
            type: "POST",
            url: svr,
            data: {filename:testid, filecontent:contents}
        });
    }catch(e){
    }
    return contents
}

</script>
</head>
<script>
</script> 
<body id="main" onload='init()' >                                      
<iframe frameborder="1" height="100px" width="100%" id="statusframe" ></iframe>
<iframe frameborder="1" height="2500px" width="100%" id="testframe" ></iframe>
</body> 
</html>
